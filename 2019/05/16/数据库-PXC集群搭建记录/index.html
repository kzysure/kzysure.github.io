<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>数据库/PXC集群搭建记录 | kzysure</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="[TOC] 一、安装Percona数据库1. 离线安装Percona 进入RPM安装文件目录，执行下面的脚本 1yum localinstall *.rpm  管理MySQL服务 123systemctl start mysqldsystemctl stop mysqldsystemctl restart mysqld    2. 在线安装Percona 使用yum命令安装 12 yum inst">
<meta property="og:type" content="article">
<meta property="og:title" content="数据库&#x2F;PXC集群搭建记录">
<meta property="og:url" content="http://www.kzysure.cn/2019/05/16/%E6%95%B0%E6%8D%AE%E5%BA%93-PXC%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E8%AE%B0%E5%BD%95/index.html">
<meta property="og:site_name" content="kzysure">
<meta property="og:description" content="[TOC] 一、安装Percona数据库1. 离线安装Percona 进入RPM安装文件目录，执行下面的脚本 1yum localinstall *.rpm  管理MySQL服务 123systemctl start mysqldsystemctl stop mysqldsystemctl restart mysqld    2. 在线安装Percona 使用yum命令安装 12 yum inst">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2019-05-16T10:42:44.000Z">
<meta property="article:modified_time" content="2020-03-08T13:43:21.148Z">
<meta property="article:author" content="kzysure">
<meta name="twitter:card" content="summary">
  
  <link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.2.0/styles/github.min.css">
  <script src="//cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', (event) => {
      document.querySelectorAll('pre code').forEach((block) => {
        hljs.highlightBlock(block);
      });
    });
  </script>
  
<link rel="stylesheet" href="/css/index.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body style="


  background-color: #eff0f6

">
  <div id="container">
    <nav id="nav">
  <header class="header">
    <a href="/" class="title">kzysure @生睿</a>
  </header>
  <div class="ctnWrap">
    <div class="icons">
      
        
          
            <a href="https://github.com/kzysure" target="_blank" class="nav-icn iconfont icon-github"></a>
          
        
      
    </div>
    <div class="menu">
      
        
            <a href="/" class="nav-menu ">主页</a>
          
        
            <a href="/archives" class="nav-menu ">归档</a>
          
        
            <a href="/about" class="nav-menu ">关于我</a>
          
        
      
    </div>
  </div>
</nav>
    <div id="main"><section class="article">
  <h2 class="title">数据库/PXC集群搭建记录</h2>
  <p class="sub">5月 16, 2019</p>
  <article class="content">
    <p>[TOC]</p>
<h1 id="一、安装Percona数据库"><a href="#一、安装Percona数据库" class="headerlink" title="一、安装Percona数据库"></a>一、安装Percona数据库</h1><h2 id="1-离线安装Percona"><a href="#1-离线安装Percona" class="headerlink" title="1. 离线安装Percona"></a>1. 离线安装Percona</h2><ul>
<li><p>进入RPM安装文件目录，执行下面的脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum localinstall *.rpm</span><br></pre></td></tr></table></figure>
</li>
<li><p>管理MySQL服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mysqld</span><br><span class="line">systemctl stop mysqld</span><br><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="2-在线安装Percona"><a href="#2-在线安装Percona" class="headerlink" title="2. 在线安装Percona"></a>2. 在线安装Percona</h2><ul>
<li><p>使用yum命令安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> yum install -y https://www.percona.com/redir/downloads/percona-release/redhat/1.0-9/percona-release-1.0-9.noarch.rpm</span><br><span class="line">yum -y install Percona-XtraDB-Cluster-57</span><br></pre></td></tr></table></figure>
</li>
<li><p>管理MySQL服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">service mysql start</span><br><span class="line">service mysql stop</span><br><span class="line">service mysql restart</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="3-开放防火墙端口"><a href="#3-开放防火墙端口" class="headerlink" title="3. 开放防火墙端口"></a>3. 开放防火墙端口</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=3306/tcp --permanent</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<h2 id="4-修改MySQL配置文件"><a href="#4-修改MySQL配置文件" class="headerlink" title="4. 修改MySQL配置文件"></a>4. 修改MySQL配置文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/my.cnf</span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">character_set_server</span> = utf8</span><br><span class="line"><span class="attr">bind-address</span> = <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line"><span class="comment">#跳过DNS解析</span></span><br><span class="line">skip-name-resolve</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service mysql restart</span><br></pre></td></tr></table></figure>

<h2 id="5-禁止开机启动MySQL"><a href="#5-禁止开机启动MySQL" class="headerlink" title="5. 禁止开机启动MySQL"></a>5. 禁止开机启动MySQL</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chkconfig mysqld off</span><br></pre></td></tr></table></figure>

<h2 id="6-初始化MySQL数据库"><a href="#6-初始化MySQL数据库" class="headerlink" title="6. 初始化MySQL数据库"></a>6. 初始化MySQL数据库</h2><ul>
<li><p>查看MySQL初始密码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /var/log/mysqld.log | grep "A temporary password"</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改MySQL密码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql_secure_installation</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建远程管理员账户</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">'admin'</span>@<span class="string">'%'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'Abc_123456'</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">all</span> <span class="keyword">privileges</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'admin'</span>@<span class="string">'%'</span>;</span><br><span class="line"><span class="keyword">FLUSH</span> <span class="keyword">PRIVILEGES</span>;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h1 id="二、创建PXC集群"><a href="#二、创建PXC集群" class="headerlink" title="二、创建PXC集群"></a>二、创建PXC集群</h1><h2 id="1-删除MariaDB程序包"><a href="#1-删除MariaDB程序包" class="headerlink" title="1. 删除MariaDB程序包"></a>1. 删除MariaDB程序包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y remove mari*</span><br></pre></td></tr></table></figure>

<h2 id="2-开放防火墙端口"><a href="#2-开放防火墙端口" class="headerlink" title="2. 开放防火墙端口"></a>2. 开放防火墙端口</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=3306/tcp --permanent</span><br><span class="line">firewall-cmd --zone=public --add-port=4444/tcp --permanent</span><br><span class="line">firewall-cmd --zone=public --add-port=4567/tcp --permanent</span><br><span class="line">firewall-cmd --zone=public --add-port=4568/tcp --permanent</span><br></pre></td></tr></table></figure>

<h2 id="3-关闭SELINUX"><a href="#3-关闭SELINUX" class="headerlink" title="3. 关闭SELINUX"></a>3. 关闭SELINUX</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/selinux/config</span><br></pre></td></tr></table></figure>

<p>把SELINUX属性值设置成disabled</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></table></figure>

<h2 id="4-离线安装PXC"><a href="#4-离线安装PXC" class="headerlink" title="4. 离线安装PXC"></a>4. 离线安装PXC</h2><ul>
<li><p>进入RPM文件目录，执行安装命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum localinstall *.rpm</span><br></pre></td></tr></table></figure>
</li>
<li><p>参考第一章内容，修改MySQL配置文件、创建账户等操作</p>
</li>
</ul>
<h2 id="5-创建PXC集群"><a href="#5-创建PXC集群" class="headerlink" title="5. 创建PXC集群"></a>5. 创建PXC集群</h2><ul>
<li><p>停止MySQL服务</p>
</li>
<li><p>修改每个PXC节点的/etc/my.cnf文件（在不同节点上，注意调整文件内容）</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server-id</span>=<span class="number">1</span>  <span class="comment">#PXC集群中MySQL实例的唯一ID，不能重复，必须是数字</span></span><br><span class="line"><span class="attr">wsrep_provider</span>=/usr/lib64/galera3/libgalera_smm.so</span><br><span class="line"><span class="attr">wsrep_cluster_name</span>=pxc-cluster  <span class="comment">#PXC集群的名称</span></span><br><span class="line"><span class="attr">wsrep_cluster_address</span>=gcomm://<span class="number">45.32</span>.<span class="number">107.21</span>,<span class="number">139.180</span>.<span class="number">215.16</span>,<span class="number">45.77</span>.<span class="number">247.18</span></span><br><span class="line"><span class="attr">wsrep_node_name</span>=pxc1  <span class="comment">#当前节点的名称</span></span><br><span class="line"><span class="attr">wsrep_node_address</span>=<span class="number">45.32</span>.<span class="number">107.21</span>  <span class="comment">#当前节点的IP</span></span><br><span class="line"><span class="attr">wsrep_sst_method</span>=xtrabackup-v2  <span class="comment">#同步方法（mysqldump、rsync、xtrabackup）</span></span><br><span class="line"><span class="attr">wsrep_sst_auth</span>= admin:Abc_123456  <span class="comment">#同步使用的帐户</span></span><br><span class="line"><span class="attr">pxc_strict_mode</span>=ENFORCING  <span class="comment">#同步严厉模式</span></span><br><span class="line"><span class="attr">binlog_format</span>=ROW  <span class="comment">#基于ROW复制（安全可靠）</span></span><br><span class="line"><span class="attr">default_storage_engine</span>=InnoDB  <span class="comment">#默认引擎</span></span><br><span class="line"><span class="attr">innodb_autoinc_lock_mode</span>=<span class="number">2</span>  <span class="comment">#主键自增长不锁表</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>主节点的管理命令（第一个启动的PXC节点）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mysql@bootstrap.service</span><br><span class="line">systemctl stop mysql@bootstrap.service</span><br><span class="line">systemctl restart mysql@bootstrap.service</span><br></pre></td></tr></table></figure>
</li>
<li><p>非主节点的管理命令（非第一个启动的PXC节点）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">service start mysql</span><br><span class="line">service stop mysql</span><br><span class="line">service restart mysql</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看PXC集群状态信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show status like &#39;wsrep_cluster%&#39; ;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>按照上述配置方法，创建两组PXC集群</strong></p>
</li>
</ul>
<h2 id="6-PXC节点启动与关闭"><a href="#6-PXC节点启动与关闭" class="headerlink" title="6. PXC节点启动与关闭"></a>6. PXC节点启动与关闭</h2><ul>
<li>如果最后关闭的PXC节点是安全退出的，那么下次启动要最先启动这个节点，而且要以主节点启动</li>
<li>如果最后关闭的PXC节点不是安全退出的，那么要先修改<code>/var/lib/mysql/grastate.dat</code> 文件，把其中的<code>safe_to_bootstrap</code>属性值设置为1，再安装主节点启动</li>
</ul>
<h1 id="三、安装MyCat"><a href="#三、安装MyCat" class="headerlink" title="三、安装MyCat"></a>三、安装MyCat</h1><h2 id="1-JDK安装与配置"><a href="#1-JDK安装与配置" class="headerlink" title="1. JDK安装与配置"></a>1. JDK安装与配置</h2><ul>
<li><p>安装JDK</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">搜索JDK版本</span></span><br><span class="line">yum search jdk </span><br><span class="line"><span class="meta">#</span><span class="bash">安装JDK1.8开发版</span></span><br><span class="line">yum install java-1.8.0-openjdk-devel.x86_64</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置环境变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">查看JDK安装路径</span></span><br><span class="line">ls -lrt /etc/alternatives/java</span><br><span class="line">vi /etc/profile</span><br><span class="line"><span class="meta">#</span><span class="bash">在文件结尾加上JDK路径，例如<span class="built_in">export</span>  JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.171-8.b10.el7_5.x86_64/</span></span><br><span class="line">source  /etc/profile</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="2-创建数据表"><a href="#2-创建数据表" class="headerlink" title="2. 创建数据表"></a>2. 创建数据表</h2><ul>
<li><p>在两组PXC集群中分别创建t_user数据表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE t_user(</span><br><span class="line">	id INT UNSIGNED PRIMARY KEY,</span><br><span class="line">    username VARCHAR(200) NOT NULL,</span><br><span class="line">    password VARCHAR(2000) NOT NULL,</span><br><span class="line">    tel CHAR(11) NOT NULL,</span><br><span class="line">    locked TINYINT(1) UNSIGNED NOT NULL DEFAULT 0,</span><br><span class="line">    INDEX idx_username(username) USING BTREE,</span><br><span class="line">    UNIQUE INDEX unq_username(username) USING BTREE</span><br><span class="line">);</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h2 id="3-MyCat安装与配置"><a href="#3-MyCat安装与配置" class="headerlink" title="3. MyCat安装与配置"></a>3. MyCat安装与配置</h2><ol>
<li><p>下载MyCat</p>
<p><a href="http://dl.mycat.io/1.6.5/Mycat-server-1.6.5-release-20180122220033-linux.tar.gz" target="_blank" rel="noopener">http://dl.mycat.io/1.6.5/Mycat-server-1.6.5-release-20180122220033-linux.tar.</a><a href="http://dl.mycat.io/1.6.5/Mycat-server-1.6.5-release-20180122220033-linux.tar.gz" target="_blank" rel="noopener">gz</a></p>
</li>
<li><p>上传MyCat压缩包到虚拟机</p>
</li>
<li><p>安装unzip程序包，解压缩MyCat</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install unzip</span><br><span class="line">unzip MyCAT压缩包名称</span><br><span class="line">或者 tar -zxvf ./Mycat-server-1.6.5-release-20180122220033-linux.tar.gz</span><br></pre></td></tr></table></figure>
</li>
<li><p>开放防火墙8066和9066端口，关闭SELINUX</p>
</li>
<li><p>修改MyCat的bin目录中所有.sh文件的权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod -R 777 .&#x2F;*.sh</span><br></pre></td></tr></table></figure>
</li>
<li><p>MyCat启动与关闭</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">cd</span> MyCat的bin目录</span></span><br><span class="line">./startup_nowrap.sh #启动MyCat</span><br><span class="line">ps -aux #查看系统进程</span><br><span class="line">kill -9 MyCat进程编号</span><br></pre></td></tr></table></figure>

</li>
</ol>
<table>
<thead>
<tr>
<th>文件</th>
<th>作用</th>
<th>修改内容</th>
</tr>
</thead>
<tbody><tr>
<td>rule.xml</td>
<td>切分算法</td>
<td>修改mod-long分片数量为2</td>
</tr>
<tr>
<td>server.xml</td>
<td>虚拟mysql</td>
<td>修改用户名/密码和逻辑库</td>
</tr>
<tr>
<td>schema.xml</td>
<td>数据库连接，读写分离，负载均衡和数据表映射</td>
<td>定义连接，读写分离，负载均衡，数据表映射</td>
</tr>
<tr>
<td>7. 修改server.xml文件，设置MyCat帐户和虚拟逻辑库</td>
<td></td>
<td></td>
</tr>
</tbody></table>
   <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line">&lt;!DOCTYPE mycat:server SYSTEM "server.dtd"&gt;</span><br><span class="line">&lt;mycat:server xmlns:mycat="http://io.mycat/"&gt;</span><br><span class="line">  	&lt;system&gt;</span><br><span class="line">  		&lt;property name="nonePasswordLogin"&gt;0&lt;/property&gt;</span><br><span class="line">  		&lt;property name="useHandshakeV10"&gt;1&lt;/property&gt;</span><br><span class="line">  		&lt;property name="useSqlStat"&gt;0&lt;/property&gt;</span><br><span class="line">  		&lt;property name="useGlobleTableCheck"&gt;0&lt;/property&gt;</span><br><span class="line">  		&lt;property name="sequnceHandlerType"&gt;2&lt;/property&gt;</span><br><span class="line">  		&lt;property name="subqueryRelationshipCheck"&gt;false&lt;/property&gt;</span><br><span class="line">  		&lt;property name="processorBufferPoolType"&gt;0&lt;/property&gt;</span><br><span class="line">  		&lt;property name="handleDistributedTransactions"&gt;0&lt;/property&gt;</span><br><span class="line">  		&lt;property name="useOffHeapForMerge"&gt;1&lt;/property&gt;</span><br><span class="line">      	&lt;property name="memoryPageSize"&gt;64k&lt;/property&gt;</span><br><span class="line">  		&lt;property name="spillsFileBufferSize"&gt;1k&lt;/property&gt;</span><br><span class="line">  		&lt;property name="useStreamOutput"&gt;0&lt;/property&gt;</span><br><span class="line">  		&lt;property name="systemReserveMemorySize"&gt;384m&lt;/property&gt;</span><br><span class="line">  		&lt;property name="useZKSwitch"&gt;false&lt;/property&gt;</span><br><span class="line">  	&lt;/system&gt;</span><br><span class="line">    &lt;!--这里是设置的admin用户和虚拟逻辑库--&gt;</span><br><span class="line">  	&lt;user name="admin" defaultAccount="true"&gt;</span><br><span class="line">  		&lt;property name="password"&gt;Abc_123456&lt;/property&gt;</span><br><span class="line">  		&lt;property name="schemas"&gt;test&lt;/property&gt;</span><br><span class="line">  	&lt;/user&gt;</span><br><span class="line">&lt;/mycat:server&gt;</span><br></pre></td></tr></table></figure>



<ol start="8">
<li><p>修改schema.xml文件，设置数据库连接和虚拟数据表t</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0"?&gt;</span><br><span class="line">&lt;!DOCTYPE mycat:schema SYSTEM "schema.dtd"&gt;</span><br><span class="line">&lt;mycat:schema xmlns:mycat="http://io.mycat/"&gt;</span><br><span class="line">  	&lt;!--配置数据表--&gt;</span><br><span class="line">  	&lt;schema name="test" checkSQLschema="false" sqlMaxLimit="100"&gt;</span><br><span class="line">  		&lt;table name="t_user" dataNode="dn1,dn2" rule="mod-long" /&gt;</span><br><span class="line">  	&lt;/schema&gt;</span><br><span class="line">  	&lt;!--配置分片关系--&gt;</span><br><span class="line">  	&lt;dataNode name="dn1" dataHost="cluster1" database="test" /&gt;</span><br><span class="line">  	&lt;dataNode name="dn2" dataHost="cluster2" database="test" /&gt;</span><br><span class="line">  	&lt;!--配置连接信息--&gt;</span><br><span class="line">  	&lt;dataHost name="cluster1" maxCon="1000" minCon="10" balance="2" </span><br><span class="line">                writeType="1" dbType="mysql" dbDriver="native" switchType="1"  </span><br><span class="line">                slaveThreshold="100"&gt;</span><br><span class="line">  		&lt;heartbeat&gt;select user()&lt;/heartbeat&gt;</span><br><span class="line">  		&lt;writeHost host="W1" url="192.168.99.151:3306" user="admin" </span><br><span class="line">                     password="Abc_123456"&gt;</span><br><span class="line">  			&lt;readHost host="W1R1" url="192.168.99.159:3306" user="admin" </span><br><span class="line">                        password="Abc_123456" /&gt;</span><br><span class="line">  			&lt;readHost host="W1R2" url="192.168.99.215:3306" user="admin" </span><br><span class="line">                        password="Abc_123456" /&gt;</span><br><span class="line">  		&lt;/writeHost&gt;</span><br><span class="line">  		&lt;writeHost host="W2" url="192.168.99.159:3306" user="admin" </span><br><span class="line">                     password="Abc_123456"&gt;</span><br><span class="line">  			&lt;readHost host="W2R1" url="192.168.99.151:3306" user="admin" </span><br><span class="line">                        password="Abc_123456" /&gt;</span><br><span class="line">  			&lt;readHost host="W2R2" url="192.168.99.215:3306" user="admin" </span><br><span class="line">                        password="Abc_123456" /&gt;</span><br><span class="line">  		&lt;/writeHost&gt;</span><br><span class="line">  	&lt;/dataHost&gt;</span><br><span class="line">  	&lt;dataHost name="cluster2" maxCon="1000" minCon="10" balance="2" </span><br><span class="line">                writeType="1" dbType="mysql" dbDriver="native" switchType="1"  </span><br><span class="line">                slaveThreshold="100"&gt;</span><br><span class="line">  		&lt;heartbeat&gt;select user()&lt;/heartbeat&gt;</span><br><span class="line">  		&lt;writeHost host="W1" url="192.168.99.121:3306" user="admin"</span><br><span class="line">  				   password="Abc_123456"&gt;</span><br><span class="line">  			&lt;readHost host="W1R1" url="192.168.99.122:3306" user="admin" </span><br><span class="line">                        password="Abc_123456" /&gt;</span><br><span class="line">  			&lt;readHost host="W1R2" url="192.168.99.123:3306" user="admin" </span><br><span class="line">                        password="Abc_123456" /&gt;</span><br><span class="line">  		&lt;/writeHost&gt;</span><br><span class="line">  		&lt;writeHost host="W2" url="192.168.99.122:3306" user="admin"</span><br><span class="line">  				   password="Abc_123456"&gt;</span><br><span class="line">  			&lt;readHost host="W2R1" url="192.168.99.121:3306" user="admin" </span><br><span class="line">                        password="Abc_123456" /&gt;</span><br><span class="line">  			&lt;readHost host="W2R2" url="192.168.99.123:3306" user="admin" </span><br><span class="line">                        password="Abc_123456" /&gt;</span><br><span class="line">  		&lt;/writeHost&gt;</span><br><span class="line">  	&lt;/dataHost&gt;</span><br><span class="line">&lt;/mycat:schema&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改rule.xml文件，把mod-long的count值修改成2</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;function name="mod-long" class="io.mycat.route.function.PartitionByMod"&gt;</span><br><span class="line">	&lt;property name="count"&gt;2&lt;/property&gt;</span><br><span class="line">&lt;/function&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启MyCat</p>
</li>
<li><p>向t_user表写入数据，感受数据的切分</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">USE test;</span><br><span class="line">#第一条记录被切分到第二个分片</span><br><span class="line">INSERT INTO t_user(id,username,password,tel,locked) VALUES(1,&quot;A&quot;,HEX(AES_ENCRYPT(&#39;123456&#39;,&#39;HelloWorld&#39;)));</span><br><span class="line">#第二条记录被切分到第一个分片</span><br><span class="line">INSERT INTO t_user(id,username,password,tel,locked) VALUES(2,&quot;B&quot;,HEX(AES_ENCRYPT(&#39;123456&#39;,&#39;HelloWorld&#39;)));</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="4-配置父子表"><a href="#4-配置父子表" class="headerlink" title="4. 配置父子表"></a>4. 配置父子表</h2><ol>
<li><p>在conf目录下创建<code>customer-hash-int</code>文件，内容如下：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">101</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">102</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">103</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">104</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">105</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">106</span>=<span class="number">1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在rule.xml文件中加入自定义<function>和<tableRule></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">"customer-hash-int"</span></span></span><br><span class="line"><span class="tag">		<span class="attr">class</span>=<span class="string">"io.mycat.route.function.PartitionByFileMap"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"mapFile"</span>&gt;</span>customer-hash-int.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">"sharding-customer"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">columns</span>&gt;</span>sharding_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>customer-hash-int<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改schema.xml文件，添加父子表定义</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"t_customer"</span> <span class="attr">dataNode</span>=<span class="string">"dn1,dn2"</span> <span class="attr">rule</span>=<span class="string">"sharding-customer"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">childTable</span> <span class="attr">name</span>=<span class="string">"t_orders"</span> <span class="attr">primaryKey</span>=<span class="string">"ID"</span> <span class="attr">joinKey</span>=<span class="string">"customer_id"</span> 	</span></span><br><span class="line"><span class="tag">                <span class="attr">parentKey</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在MyCat上执行如下SQL：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">USE test;</span><br><span class="line">CREATE TABLE t_customer(</span><br><span class="line">	id INT UNSIGNED PRIMARY KEY,</span><br><span class="line">    username VARCHAR(200) NOT NULL,</span><br><span class="line">    sharding_id INT NOT NULL</span><br><span class="line">);</span><br><span class="line">CREATE TABLE t_orders(</span><br><span class="line">	id INT UNSIGNED PRIMARY KEY,</span><br><span class="line">    customer_id INT NOT NULL,</span><br><span class="line">    datetime TIMESTAMP DEFAULT CURRENT_TIMSTAMP</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
</li>
<li><p>向t_customer表和t_orders表写入数据，查看字表数据跟随父表切分到同一个分片</p>
<h2 id="数据切分算法比较"><a href="#数据切分算法比较" class="headerlink" title="数据切分算法比较"></a>数据切分算法比较</h2></li>
</ol>
<table>
<thead>
<tr>
<th>切分算法</th>
<th>适用场景</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>主键值求模切分</td>
<td>数据增长慢，难于增加分片</td>
<td>有明确的主键值</td>
</tr>
<tr>
<td>枚举值切分</td>
<td>归类存档数据，适合大多数业务场景</td>
<td></td>
</tr>
<tr>
<td>主键值范围切分</td>
<td>数据增长速度快，容易增加分片</td>
<td>有明确主键值，切数据无法归档</td>
</tr>
<tr>
<td>日期切分</td>
<td>数据增长快，容易增加分片</td>
<td>无法归档</td>
</tr>
<tr>
<td>### 各种切分比较</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<blockquote>
<p>主键值求模切分：适合初始数据大，但是增长不快的业务，如地图，行政数据，企业数据，因为新分片很难增加，非得增加则按照倍数增加分片<br>枚举值切分：即按照某个字段的值（数字）进行切分，</p>
</blockquote>
<h2 id="5-创建双机热备的MyCat集群"><a href="#5-创建双机热备的MyCat集群" class="headerlink" title="5. 创建双机热备的MyCat集群"></a>5. 创建双机热备的MyCat集群</h2><ol>
<li><p>用两个虚拟机实例，各自部署MyCat</p>
</li>
<li><p>用一个虚拟机实例部署Haproxy</p>
<ul>
<li><p>安装Haproxy</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y haproxy</span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/haproxy/haproxy.cfg</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">global</span><br><span class="line">    log         127.0.0.1 local2</span><br><span class="line">    chroot      &#x2F;var&#x2F;lib&#x2F;haproxy</span><br><span class="line">    pidfile     &#x2F;var&#x2F;run&#x2F;haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line">    # turn on stats unix socket</span><br><span class="line">    stats socket &#x2F;var&#x2F;lib&#x2F;haproxy&#x2F;stats</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    mode                    http</span><br><span class="line">    log                     global</span><br><span class="line">    option                  httplog</span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option http-server-close</span><br><span class="line">    option forwardfor       except 127.0.0.0&#x2F;8</span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout http-request    10s</span><br><span class="line">    timeout queue           1m</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout client          1m</span><br><span class="line">    timeout server          1m</span><br><span class="line">    timeout http-keep-alive 10s</span><br><span class="line">    timeout check           10s</span><br><span class="line">    maxconn                 3000</span><br><span class="line"></span><br><span class="line">listen   admin_stats  </span><br><span class="line">    bind    0.0.0.0:4001</span><br><span class="line">    mode  http</span><br><span class="line">    stats uri       &#x2F;dbs</span><br><span class="line">    stats realm  Global\ statistics</span><br><span class="line">    stats auth    admin:abc123456</span><br><span class="line">listen   proxy-mysql</span><br><span class="line">    bind    0.0.0.0:3306  </span><br><span class="line">    mode  tcp </span><br><span class="line">    balance  roundrobin</span><br><span class="line">    option  tcplog       #日志格式</span><br><span class="line">    server   mycat_1  139.180.211.180:8066  check  port  8066  maxconn  2000  </span><br><span class="line">    server   mycat_2  45.32.255.46:8066  check  port  8066  maxconn  2000  </span><br><span class="line">    option  tcpka        #使用keepalive检测死链</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动Haproxy</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service haproxy start</span><br></pre></td></tr></table></figure>
</li>
<li><p>访问Haproxy监控画面</p>
<p><a href="http://192.168.99.131:4001/dbs" target="_blank" rel="noopener">http://192.168.99.131:4001/dbs</a></p>
</li>
</ul>
</li>
<li><p>用另外一个虚拟机同样按照上述操作安装Haproxy</p>
</li>
<li><p>在某个Haproxy虚拟机实例上部署Keepalived</p>
<ul>
<li><p>开启防火墙的VRRP协议</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">开启VRRP</span></span><br><span class="line">firewall-cmd --direct --permanent --add-rule ipv4 filter INPUT 0 --protocol  vrrp -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash">应用设置</span></span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装Keepalived</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y keepalived</span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/keepalived/keepalived.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vrrp_instance  VI_1 &#123;</span><br><span class="line">    state  MASTER</span><br><span class="line">    interface  ens33</span><br><span class="line">    virtual_router_id  51</span><br><span class="line">    priority  100</span><br><span class="line">    advert_int  1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type  PASS</span><br><span class="line">        auth_pass  123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.99.133</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动Keepalived</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service keepalived start</span><br></pre></td></tr></table></figure>
</li>
<li><p>ping 192.168.99.133</p>
</li>
</ul>
</li>
<li><p>在另外一个Haproxy虚拟机上，按照上述方法部署Keepalived</p>
</li>
<li><p>使用MySQL客户端连接192.168.99.133，执行增删改查数据</p>
</li>
</ol>
<h1 id="四、Sysbench基准测试"><a href="#四、Sysbench基准测试" class="headerlink" title="四、Sysbench基准测试"></a>四、Sysbench基准测试</h1><h2 id="1-安装Sysbench"><a href="#1-安装Sysbench" class="headerlink" title="1. 安装Sysbench"></a>1. 安装Sysbench</h2><ul>
<li><p>在线安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -s https://packagecloud.io/install/</span><br><span class="line">repositories/akopytov/sysbench/script.rpm.sh | sudo bash</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install sysbench</span><br></pre></td></tr></table></figure>
</li>
<li><p>本地安装</p>
<ul>
<li><p>下载压缩文件</p>
<p><a href="https://codeload.github.com/akopytov/sysbench/zip/1.0" target="_blank" rel="noopener">https://</a><a href="https://codeload.github.com/akopytov/sysbench/zip/1.0" target="_blank" rel="noopener">codeload.github.com/akopytov/sysbench/zip/1.0</a></p>
</li>
<li><p>安装依赖包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y automake libtool</span><br><span class="line">yum install -y mysql-devel</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">cd</span> sysbench</span></span><br><span class="line">./autogen.sh </span><br><span class="line">./configure </span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line">sysbench --version</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h2 id="2-执行测试"><a href="#2-执行测试" class="headerlink" title="2. 执行测试"></a>2. 执行测试</h2><ul>
<li><p>准备测试库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench  /usr/share/sysbench/tests/include/oltp_legacy/oltp.lua --mysql-host=192.168.99.131 --mysql-port=3306 --mysql-user=admin --mysql-password=Abc_123456 --oltp-tables-count=10 --oltp-table-size=100000 prepare</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行测试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench  /usr/share/sysbench/tests/include/oltp_legacy/oltp.lua --mysql-host=192.168.99.131 --mysql-port=3306 --mysql-user=admin --mysql-password=Abc_123456 --oltp-test-mode=complex --threads=10 --time=300 --report-interval=10 run &gt;&gt; /home/mysysbench.log</span><br></pre></td></tr></table></figure>
</li>
<li><p>清理数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench /usr/share/sysbench/tests/include/oltp_legacy/oltp.lua --mysql-host=192.168.99.131 --mysql-port=3306 --mysql-user=admin --mysql-password=Abc_123456 --oltp-tables-count=10 cleanup</span><br></pre></td></tr></table></figure>


</li>
</ul>
<h1 id="五、tpcc-mysql-压力测试"><a href="#五、tpcc-mysql-压力测试" class="headerlink" title="五、tpcc-mysql 压力测试"></a>五、tpcc-mysql 压力测试</h1><h2 id="1-准备工作"><a href="#1-准备工作" class="headerlink" title="1. 准备工作"></a>1. 准备工作</h2><ul>
<li><p>修改my.cnf配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/my.cnf</span><br></pre></td></tr></table></figure>

<p>pxc_strict_mode=DISABLED</p>
</li>
<li><p>修改某个Haproxy的配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server   mysql_1  192.168.99.151:3306  check  port  3306  weight  1  maxconn  2000</span><br><span class="line">server   mysql_2  192.168.99.159:3306  check  port  3306  weight  1  maxconn  2000</span><br><span class="line">server   mysql_3  192.168.99.215:3306  check  port  3306  weight  1  maxconn  2000</span><br></pre></td></tr></table></figure>
</li>
<li><p>重新启动Haproxy</p>
</li>
<li><p>安装依赖程序包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y gcc</span><br><span class="line">yum install -y mysql-devel</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="2-安装tpcc-mysql"><a href="#2-安装tpcc-mysql" class="headerlink" title="2. 安装tpcc-mysql"></a>2. 安装tpcc-mysql</h2><ul>
<li><p>下载压缩包</p>
<p><a href="https://codeload.github.com/Percona-Lab/tpcc-mysql/zip/master" target="_blank" rel="noopener">https://codeload.github.com/Percona-Lab/tpcc-mysql/zip/</a><a href="https://codeload.github.com/Percona-Lab/tpcc-mysql/zip/master" target="_blank" rel="noopener">master</a></p>
</li>
<li><p>执行安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">cd</span> tpcc的src目录</span></span><br><span class="line">make</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行<code>create_table.sql</code>和<code>add_fkey_idx.sql</code>两个文件</p>
</li>
<li><p>执行数据初始化</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./tpcc_load -h 192.168.99.131 -d tpcc -u admin -p Abc_123456 -w</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行压力测试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./tpcc_start -h 192.168.99.131 -d tpcc -u admin -p Abc_123456 -w 1 -c 5 -r 300 -l 600 -&gt;tpcc-output-log</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="六、导入数据"><a href="#六、导入数据" class="headerlink" title="六、导入数据"></a>六、导入数据</h1><h2 id="1-生成1000万条数据"><a href="#1-生成1000万条数据" class="headerlink" title="1. 生成1000万条数据"></a>1. 生成1000万条数据</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileWriter</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedWriter</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">	<span class="function">def <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">var</span> writer=<span class="keyword">new</span> FileWriter(<span class="string">"D:/data.txt"</span>)</span><br><span class="line">		<span class="keyword">var</span> buff=<span class="keyword">new</span> BufferedWriter(writer)</span><br><span class="line">		<span class="keyword">for</span>(i:<span class="number">1</span>..<span class="number">10000000</span>)&#123;</span><br><span class="line">			buff.write(i+<span class="string">",测试数据\n"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		buff.close</span><br><span class="line">		writer.close</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-执行文件切分"><a href="#2-执行文件切分" class="headerlink" title="2. 执行文件切分"></a>2. 执行文件切分</h2><ul>
<li><p>上传data.txt文件到linux</p>
</li>
<li><p>执行文件切分</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">split -l 1000000 -d data.txt</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="3-准备数据库"><a href="#3-准备数据库" class="headerlink" title="3. 准备数据库"></a>3. 准备数据库</h2><ul>
<li><p>每个PXC分片只开启一个节点</p>
</li>
<li><p>修改PXC节点文件，然后重启PXC服务</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">innodb_flush_log_at_trx_commit</span> = <span class="number">0</span></span><br><span class="line"><span class="attr">innodb_flush_method</span> = O_DIRECT</span><br><span class="line"><span class="attr">innodb_buffer_pool_size</span> = <span class="number">200</span>M</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建t_test数据表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE t_test(</span><br><span class="line">	id INT UNSIGNED PRIMARY KEY,</span><br><span class="line">    name VARCHAR(200) NOT NULL</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置MyCat</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"t_test"</span> <span class="attr">dataNode</span>=<span class="string">"dn1,dn2"</span> <span class="attr">rule</span>=<span class="string">"mod-long"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">"cluster1"</span> <span class="attr">maxCon</span>=<span class="string">"1000"</span> <span class="attr">minCon</span>=<span class="string">"10"</span> <span class="attr">balance</span>=<span class="string">"0"</span> <span class="attr">writeType</span>=<span class="string">"1"</span> </span></span><br><span class="line"><span class="tag">          <span class="attr">dbType</span>=<span class="string">"mysql"</span> <span class="attr">dbDriver</span>=<span class="string">"native"</span> <span class="attr">switchType</span>=<span class="string">"1"</span> <span class="attr">slaveThreshold</span>=<span class="string">"100"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">"W1"</span> <span class="attr">url</span>=<span class="string">"192.168.99.151:3306"</span> <span class="attr">user</span>=<span class="string">"admin"</span> </span></span><br><span class="line"><span class="tag">               <span class="attr">password</span>=<span class="string">"Abc_123456"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">"cluster2"</span> <span class="attr">maxCon</span>=<span class="string">"1000"</span> <span class="attr">minCon</span>=<span class="string">"10"</span> <span class="attr">balance</span>=<span class="string">"0"</span> <span class="attr">writeType</span>=<span class="string">"1"</span> </span></span><br><span class="line"><span class="tag">          <span class="attr">dbType</span>=<span class="string">"mysql"</span> <span class="attr">dbDriver</span>=<span class="string">"native"</span> <span class="attr">switchType</span>=<span class="string">"1"</span> <span class="attr">slaveThreshold</span>=<span class="string">"100"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">"W1"</span> <span class="attr">url</span>=<span class="string">"192.168.99.121:3306"</span> <span class="attr">user</span>=<span class="string">"admin"</span> </span></span><br><span class="line"><span class="tag">               <span class="attr">password</span>=<span class="string">"Abc_123456"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br></pre></td></tr></table></figure>


</li>
</ul>
<h2 id="4-执行Java程序，多线程导入数据"><a href="#4-执行Java程序，多线程导入数据" class="headerlink" title="4. 执行Java程序，多线程导入数据"></a>4. 执行Java程序，多线程导入数据</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.eclipse.xtend.lib.annotations.Accessors</span><br><span class="line"><span class="keyword">import</span> java.io.File</span><br><span class="line"><span class="keyword">import</span> java.sql.DriverManager</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">	<span class="meta">@Accessors</span></span><br><span class="line">	File file;</span><br><span class="line">	</span><br><span class="line">	<span class="function">override <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">var</span> url=<span class="string">"jdbc:mysql://192.168.99.131:8066/test"</span></span><br><span class="line">		<span class="keyword">var</span> username=<span class="string">"admin"</span></span><br><span class="line">		<span class="keyword">var</span> password=<span class="string">"Abc_123456"</span></span><br><span class="line">		<span class="keyword">var</span> con=DriverManager.getConnection(url,username,password)</span><br><span class="line">		<span class="keyword">var</span> sql=<span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">			load data local intfile '</span>/home/data/«file.name»<span class="string">' ignore into table t_test </span></span><br><span class="line"><span class="string">			character set '</span>utf8<span class="string">' </span></span><br><span class="line"><span class="string">			fields terminated by '</span>,<span class="string">' optionally enclosed by '</span>\<span class="string">"' </span></span><br><span class="line"><span class="string">			lines terminated by '\n' (id,name);</span></span><br><span class="line"><span class="string">		'''</span></span><br><span class="line"><span class="string">		var pst=con.prepareStatement(sql);</span></span><br><span class="line"><span class="string">		pst.execute</span></span><br><span class="line"><span class="string">		con.close</span></span><br><span class="line"><span class="string">		LoadData.updateNum();</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.mysql.jdbc.Driver</span><br><span class="line"><span class="keyword">import</span> java.sql.DriverManager</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.LinkedBlockingQueue</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadPoolExecutor</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit</span><br><span class="line"><span class="keyword">import</span> java.io.File</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoadData</span> </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> <span class="keyword">static</span> <span class="keyword">int</span> num=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">var</span> <span class="keyword">static</span> <span class="keyword">int</span> end=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">var</span> <span class="keyword">static</span> pool=<span class="keyword">new</span> ThreadPoolExecutor(<span class="number">1</span>,<span class="number">5</span>,<span class="number">60</span>,TimeUnit.SECONDS,<span class="keyword">new</span> LinkedBlockingQueue(<span class="number">200</span>))</span><br><span class="line">	<span class="function">def <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		DriverManager.registerDriver(<span class="keyword">new</span> Driver)</span><br><span class="line">		<span class="keyword">var</span> folder=<span class="keyword">new</span> File(<span class="string">"/home/data"</span>)</span><br><span class="line">		<span class="keyword">var</span> files=folder.listFiles</span><br><span class="line">		end=files.length <span class="comment">//线程池结束条件</span></span><br><span class="line">		files.forEach[one|</span><br><span class="line">			<span class="keyword">var</span> task=<span class="keyword">new</span> Task();</span><br><span class="line">			task.file=one;</span><br><span class="line">			pool.execute(task)</span><br><span class="line">		]</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">synchronized</span> def <span class="keyword">static</span> <span class="title">updateNum</span><span class="params">()</span></span>&#123;</span><br><span class="line">		num++;</span><br><span class="line">		<span class="keyword">if</span>(num==end)&#123;</span><br><span class="line">			pool.shutdown();</span><br><span class="line">			println(<span class="string">"执行结束"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="七、大数据归档"><a href="#七、大数据归档" class="headerlink" title="七、大数据归档"></a>七、大数据归档</h1><h2 id="1-安装TokuDB"><a href="#1-安装TokuDB" class="headerlink" title="1. 安装TokuDB"></a>1. 安装TokuDB</h2><ul>
<li><p>安装jemlloc</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y jemalloc</span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/my.cnf</span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">……</span><br><span class="line"><span class="section">[mysqld_safe]</span></span><br><span class="line"><span class="attr">malloc-lib</span>=/usr/lib64/libjemalloc.so.<span class="number">1</span></span><br><span class="line">……</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启MySQL</p>
</li>
<li><p>开启Linux大页内存</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line">echo never &gt; /sys/kernel/mm/transparent_hugepage/defrag</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装TokuDB</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install -y Percona-Server-tokudb-57.x86_64</span><br><span class="line">ps-admin --enable -uroot -p</span><br><span class="line">service mysql restart</span><br><span class="line">ps-admin --enable -uroot -p</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看安装结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show engines ;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="2-配置Replication集群"><a href="#2-配置Replication集群" class="headerlink" title="2. 配置Replication集群"></a>2. 配置Replication集群</h2><ul>
<li><p>在两个TokuDB数据库上创建用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE USER &#39;backup&#39;@&#39;%&#39; IDENTIFIED BY &#39;Abc_123456&#39; ;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRANT super, reload, replication slave ON *.* TO &#39;backup&#39;@&#39;%&#39; ;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FLUSH  PRIVILEGES ;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改两个TokuDB的配置文件，如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">server_id</span> = <span class="number">101</span></span><br><span class="line"><span class="attr">log_bin</span> = mysql_bin</span><br><span class="line"><span class="attr">relay_log</span> = relay_bin</span><br><span class="line">……</span><br></pre></td></tr></table></figure>

<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">server_id</span> = <span class="number">102</span></span><br><span class="line"><span class="attr">log_bin</span> = mysql_bin</span><br><span class="line"><span class="attr">relay_log</span> = relay_bin</span><br></pre></td></tr></table></figure>
</li>
<li><p>重新启动两个TokuDB节点</p>
</li>
<li><p>分别在两个TokuDB上执行下面4句SQL</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#关闭同步服务</span><br><span class="line">stop slave;</span><br><span class="line">#设置同步的Master节点</span><br><span class="line">change master to master_host&#x3D;&quot;192.168.99.155&quot;,master_port&#x3D;3306,master_user&#x3D;&quot;backup&quot;,</span><br><span class="line">master_password&#x3D;&quot;Abc_123456&quot;;</span><br><span class="line">#启动同步服务</span><br><span class="line">start slave;</span><br><span class="line">#查看同步状态</span><br><span class="line">show slave status;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#关闭同步服务</span><br><span class="line">stop slave;</span><br><span class="line">#设置同步的Master节点</span><br><span class="line">change master to master_host&#x3D;&quot;192.168.99.102&quot;,master_port&#x3D;3306,master_user&#x3D;&quot;backup&quot;,</span><br><span class="line">master_password&#x3D;&quot;Abc_123456&quot;;</span><br><span class="line">#启动同步服务</span><br><span class="line">start slave;</span><br><span class="line">#查看同步状态</span><br><span class="line">show slave status;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="3-创建归档表"><a href="#3-创建归档表" class="headerlink" title="3. 创建归档表"></a>3. 创建归档表</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE t_purchase (</span><br><span class="line">	id INT UNSIGNED PRIMARY KEY,</span><br><span class="line">	purchase_price DECIMAL(10,2) NOT NULL,</span><br><span class="line">	purchase_num INT UNSIGNED NOT NULL,</span><br><span class="line">	purchase_sum DECIMAL (10,2) NOT NULL,</span><br><span class="line">	purchase_buyer INT UNSIGNED NOT NULL,</span><br><span class="line">	purchase_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,</span><br><span class="line">	company_id INT UNSIGNED NOT NULL,</span><br><span class="line">	goods_id INT UNSIGNED NOT NULL,</span><br><span class="line">	KEY idx_company_id(company_id),</span><br><span class="line">	KEY idx_goods_id(goods_id)</span><br><span class="line">)engine&#x3D;TokuDB;</span><br></pre></td></tr></table></figure>

<h2 id="4-配置Haproxy-Keepalived双机热备"><a href="#4-配置Haproxy-Keepalived双机热备" class="headerlink" title="4. 配置Haproxy+Keepalived双机热备"></a>4. 配置Haproxy+Keepalived双机热备</h2><ul>
<li><p>在两个节点上安装Haproxy</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y haproxy</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/haproxy/haproxy.cfg</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">global</span><br><span class="line">    log         127.0.0.1 local2</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line">    # turn on stats unix socket</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    mode                    http</span><br><span class="line">    log                     global</span><br><span class="line">    option                  httplog</span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option http-server-close</span><br><span class="line">    option forwardfor       except 127.0.0.0/8</span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout http-request    10s</span><br><span class="line">    timeout queue           1m</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout client          1m</span><br><span class="line">    timeout server          1m</span><br><span class="line">    timeout http-keep-alive 10s</span><br><span class="line">    timeout check           10s</span><br><span class="line">    maxconn                 3000</span><br><span class="line"></span><br><span class="line">listen   admin_stats  </span><br><span class="line">    bind    0.0.0.0:4001</span><br><span class="line">    mode  http</span><br><span class="line">    stats uri       /dbs</span><br><span class="line">    stats realm  Global\ statistics</span><br><span class="line">    stats auth    admin:abc123456</span><br><span class="line">listen   proxy-mysql</span><br><span class="line">    bind    0.0.0.0:4002  </span><br><span class="line">    mode  tcp </span><br><span class="line">    balance  roundrobin</span><br><span class="line">    option  tcplog       #日志格式</span><br><span class="line">    server   backup_1  192.168.99.102:3306  check  port  3306  maxconn  2000  </span><br><span class="line">    server   backup_2  192.168.99.155:3306  check  port  3306  maxconn  2000  </span><br><span class="line">    option  tcpka        #使用keepalive检测死链</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启Haproxy</p>
</li>
<li><p>开启防火墙的VRRP协议</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --direct --permanent --add-rule ipv4 filter INPUT 0 --protocol vrrp -j ACCEPT</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>
</li>
<li><p>在两个节点上安装Keepalived</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y keepalived</span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑Keepalived配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/keepalived/keepalived.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vrrp_instance  VI_1 &#123;</span><br><span class="line">    state  MASTER</span><br><span class="line">    interface  ens33</span><br><span class="line">    virtual_router_id  51</span><br><span class="line">    priority  100</span><br><span class="line">    advert_int  1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type  PASS</span><br><span class="line">        auth_pass  123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.99.211</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启Keepalived</p>
</li>
</ul>
<h2 id="5-准备归档数据"><a href="#5-准备归档数据" class="headerlink" title="5. 准备归档数据"></a>5. 准备归档数据</h2><ul>
<li><p>在两个PXC分片上创建进货表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE t_purchase (</span><br><span class="line">	id INT UNSIGNED PRIMARY KEY,</span><br><span class="line">	purchase_price DECIMAL(10,2) NOT NULL,</span><br><span class="line">	purchase_num INT UNSIGNED NOT NULL,</span><br><span class="line">	purchase_sum DECIMAL (10,2) NOT NULL,</span><br><span class="line">	purchase_buyer INT UNSIGNED NOT NULL,</span><br><span class="line">	purchase_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,</span><br><span class="line">	company_id INT UNSIGNED NOT NULL,</span><br><span class="line">	goods_id INT UNSIGNED NOT NULL,</span><br><span class="line">	KEY idx_company_id(company_id),</span><br><span class="line">	KEY idx_goods_id(goods_id)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置MyCat的schema.xml文件，并重启MyCat</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"t_purchase"</span> <span class="attr">dataNode</span>=<span class="string">"dn1,dn2"</span> <span class="attr">rule</span>=<span class="string">"mod-long"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="6-执行数据归档"><a href="#6-执行数据归档" class="headerlink" title="6. 执行数据归档"></a>6. 执行数据归档</h2><ul>
<li><p>安装pt-archiver</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install percona-toolkit</span><br><span class="line">pt-archiver --version</span><br><span class="line">pt-archiver --help</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行数据归档</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-archiver --source h=192.168.99.102,P=8066,u=admin,p=Abc_123456,D=test,t=t_purchase --dest h=192.168.99.102,P=3306,u=admin,p=Abc_123456,D=test,t=t_purchase --no-check-charset --where 'purchase_date&lt;"2018-09"' --progress 5000 --bulk-delete --bulk-insert --limit=10000 --statistics</span><br></pre></td></tr></table></figure>










</li>
</ul>

  </article>
  <footer class="f-cf">
    
      <a href="/2019/07/08/guava%E5%9C%A8%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E4%BA%8C%E7%BA%A7%E7%BC%93%E5%AD%98%E7%9A%84%E5%AE%9E%E8%B7%B5/" class="link f-fl">⟵guava在系统中的二级缓存的实践</a>
    
    
      <a href="/2019/05/02/%E6%95%B0%E6%8D%AE%E5%BA%93-mysql%E9%9B%86%E7%BE%A4%E5%92%8Cmysql%E7%9A%84%E5%88%86%E6%94%AF%E6%AF%94%E8%BE%83/" class="link f-fr">数据库/mysql集群和mysql的分支比较⟶</a>
    
  </footer>
</section></div>
    <footer id="footer" class="f-cf">
  kzysure@kzysure.com
  
    
      
        · <a href="https://github.com/kzysure" target="_blank" class="nav-icn">GitHub</a>
      
    
  
  <span class="copyright">2015-2020 All rights reserved @kzysure</span>
</footer>
  </div>
</body>
</html>